#===================================================================================
# https://github.com/ccccmagicboy/MicroPython_fw_action
# Description: Build MicroPython firmware using GitHub Actions for WIN32
# Lisence: MIT
# Author: ccccmagicboy
# Url: https://ccrobot-online.com
#===================================================================================

name: WIN32_BUILD

on:
  push:
    branches:
      - master
    paths-ignore:
    - '**.md'  
      # schedule:
    # - cron: 0 8 * * 5
  # watch:
    # types: [started]

env:
  REPO_URL: https://github.com/micropython/micropython.git
  REPO_BRANCH: master

jobs:
  build:
    runs-on: ubuntu-16.04

    steps:
    - name: Checkout this repos
      uses: actions/checkout@v2    
      
    - name: Install the toolchain
      run: |
        sudo apt-get install gcc-mingw-w64
      
    - name: Clone the micropython source code
      run: |
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH my_micropython
        git submodule update --init
        
    - name: Build the mpy-cross tool
      run: |
        cd my_micropython
        pwd
        ls -al
        make -C mpy-cross
        
    - name: Build the unix port
      run: |
        cd my_micropython/ports/unix
        make submodules
        make
        find . -name "*micropython*"
        ./micropython -c "import sys;print(sys.implementation)"
        
    - name: Build the Windows port
      run: |        
        cd my_micropython/ports/windows/
        pwd
        ls -al   
        make CROSS_COMPILE=i686-w64-mingw32-
        ls -al
        
    - name: Zip the artifact
      run: |
        zip --junk-paths micropython_win32 my_micropython/ports/windows/micropython.exe README.md MicroPython_fw_action_card.png
        
    - name: Upload the zip file
      uses: actions/upload-artifact@master
      with:
        name: micropython_win32
        path: micropython_win32.zip
            